<!DOCTYPE html>
<html lang="en">
      <head>
            <meta charset="utf-8">
            <meta content="width=device-width, initial-scale=1.0" name="viewport">
            <title>Projects - Statistical Analysis of Climate Data Using Time Series - Part 1: Data Preparation and Advanced Visualization Using The Washington Post's series, "2ºC: Beyond the Limit." Data</title>
            <meta content="" name="description">
            <meta content="" name="keywords">
            <!-- Favicons -->
            <link href="../../assets/img/web-icon.png" rel="icon">
            <link href="../../assets/img/apple-touch-icon.png" rel="apple-touch-icon">
            <!-- Google Fonts -->
            <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Roboto:300,300i,400,400i,500,500i,700,700i&display=swap" rel="stylesheet">
            <!-- Vendor CSS Files -->
            <link href="../../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
            <link href="../../assets/vendor/animate.css/animate.min.css" rel="stylesheet">
            <link href="../../assets/vendor/icofont/icofont.min.css" rel="stylesheet">
            <link href="../../assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
            <link href="../../assets/vendor/venobox/venobox.css" rel="stylesheet">
            <link href="../../assets/vendor/owl.carousel/assets/owl.carousel.min.css" rel="stylesheet">
            <link href="../../assets/vendor/aos/aos.css" rel="stylesheet">
            <!-- Template Main CSS File -->
            <link href="../../assets/css/style.css" rel="stylesheet">
            <link href="../../assets/css/prism.css" rel="stylesheet">
      </head>
      <body>
            <!-- ======= Header ======= -->
            <header id="header" class="fixed-top ">
                  <div class="container">
                        <div class="logo float-left">
                              <h1 class="text-light"><a href="../../index.html"><span>Alimr.dev</span></a></h1>
                        </div>
                        <nav class="nav-menu float-right d-none d-lg-block">
                              <ul>
                                    <li><a href="../../index.html">Home</a></li>
                                    <li class="active"><a href="../../projects.html">Projects</a></li>
                                    <li class="drop-down"><a href="../../tutorials.html">Tutorials</a>
                                    <ul>
                                    <li><a href="../../tutorials.html#Pandas">Pandas</a></li>
                                    <li class="drop-down"><a href="../../tutorials.html#Machine-Learning">Machine Learning</a>
                                    <ul>
                                          <li><a href="linear_regression.html">Linear Regression</a></li>
                                          <li><a href="linear_regression.html">Support Vector Machines</a></li>
                                          <li><a href="linear_regression.html">Naive Bayes</a></li>
                                          <li><a href="linear_regression.html">Decision Trees</a></li>
                                          <li><a href="linear_regression.html">Ensemble Methods</a></li>
                                    </ul>
                                    </li>
                                    <li><a href="../../tutorials.html#Linear-Algebra">Linear Algebra</a></li>
                                    <li><a href="../../tutorials.html#Visualization">Visualization</a></li>
                                    <li><a href="../../tutorials.html#Jupyter-Notebook">Jupyter Notebook</a></li>
                                    <li><a href="../../tutorials.html#Git">Git</a></li>
                                    <li><a href="../../tutorials.html#Bash">Bash</a></li>
                                    <li><a href="../../tutorials.html#Deep-Learning">Deep Learning</a></li>
                                    <li><a href="../../tutorials.html#Conda">Conda</a></li>
                                    <li><a href="../../tutorials.html#Numerical-Methods">Numerical Methods</a></li>
                                    <li><a href="../../tutorials.html#Big-Data">Big Data</a></li>
                                    <li><a href="../../tutorials.html#Classification">Classification</a></li>
                                    <li><a href="../../tutorials.html#Pattern-Recognition">Pattern Recognition</a></li>
                                    <li><a href="../../tutorials.html#SQL">SQL</a></li>
                              </ul>
                        </li>
                        <li><a href="../../about.html">About Me</a></li>
                        <li><a href="../../contact.html">Contact</a></li>
                  </ul>
                  </nav><!-- .nav-menu -->
            </div>
            </header><!-- End Header -->
            <main id="main">
                  <!-- ======= About Us Section ======= -->
                  <section class="breadcrumbs">
                        <div class="container">
                              <div class="d-flex justify-content-between align-items-center">
                                    <h2>Projects</h2>
                                    <ol>
                                    <li><a href="../../projects.html">Projects</a></li>
                                    <li>Data Preparation and Advanced Visualization Using The Washington Post's series, "2ºC: Beyond the Limit." Data</li>
                                    </ol>
                              </div>
                        </div>
                  </section>
                  <!-- End Header -->
                  <section class="projects" data-aos="fade-up" data-aos-easing="ease-in-out" data-aos-duration="1000">
                        <div class="container">
                              <div class="row">
                                    <div class="col-12">
                                          <h2>Data Preparation and Advanced Visualization Using The Washington Post's series, "2ºC: Beyond the Limit." Data</h2>
                                          <p>
                                                Climate change and global warming are real, observable, and measurable. This project conducts time series analysis using the data supporting The Washington Post's series, "2ºC: Beyond the Limit.", to quantify the links between the climate variation and different drivers of change.
                                          </p>
                                          <h3>Motivation and Summary</h3>
                                          <p>
                                                I got really interested in finding and analyzing this data set after reading the Washington Post's article. Here's the link to WP's github repository and some more details about the data set:
                                                <ul>
                                                      <li>
                                                            The data supporting the Washington Post's series, <a href="https://www.washingtonpost.com/graphics/2019/national/climate-environment/climate-change-world/?itid=lk_inline_manual_1&itid=lk_inline_manual_1"><span>2</span>°<span class="text">C: Beyond the limit</span></a>, that was awarded the Pulitzer prize for explanatory reporting (<a href="https://github.com/washingtonpost/data-2C-beyond-the-limit-usa">link to data</a>). The dataset includes:
                                                            <ul>
                                                                  <dd><code>fips</code>: A five digit fips code for the county</dd>
                                                                  <dd><code>CTYNAME</code>: the name of the county</dd>
                                                                  <dd><code>STNAME</code>: the name of the state</dd>
                                                                  <dd><code>Annual</code>: Estimate of annual average temperature change in Celsius for the county, 1895-2019</dd>
                                                                  <dd><code>Fall</code>: temperature change in September, October and November</dd>
                                                                  <dd><code>Spring</code>: temperature change in March, April and May</dd>
                                                                  <dd><code>Summer</code>: temperature change in June, July and August</dd>
                                                                  <dd><code>Winter</code>: temperature change in December and the following January and February</dd>
                                                                  <dd><code>max_warming_season</code>: the season where temperatures are increasing fastest</dd>
                                                            </ul>
                                                      </li>
                                                </ul>
                                          </p>
                                          <p>
                                                The data set includes county-level annual temperatures for the US counties. It can be used, as is and without much cleaning, for analysis and visualization purposes. However, after going through the raw files in the repository, I realized there's another <a href="https://github.com/washingtonpost/data-2C-beyond-the-limit-usa/blob/main/data/raw/climdiv-tmpccy-v1.0.0-20200106">file</a> that has the data above with more details, where the average <strong>temperature for each county is recorded monthly</strong> for the same period of time (1895-2019). This is great because it gives me a better opportunity to analyze not only the long-time behavior of the temperature time series (<strong>Drift</strong>) but also the <strong>Seasonal</strong> fluctuations over time.
                                          </p>
                                          <p>
                                                I decided to breakdown this project into two parts where in <strong>part 1</strong>, I go through the <strong>data cleaning, data imputation, and data visualization using <code class="library"><a href="https://plotly.com/">Plotly</a></code></strong>. In <strong>part 2</strong>, I use the data from part 1 to <strong>design a <em>'Drift' + 'Seasonal' + 'Noise'</em> time series model for temperature forecasting</strong>.
                                          </p>
                                          <h3>Data Exploration</h3>
                                          <p>
                                                Here's the first few lines of the raw file:
                                          </p>
                                          <pre class="prettyprint lang-language"><code class="language-python">head -5 climdiv-tmpccy-v1.0.0-20200106</code></pre>
                                          <pre>01001021895  44.00  38.20  55.50  64.10  70.60  78.30  80.40  80.40  79.00  61.40  54.40  45.30   
01001021896  44.30  49.00  54.00  69.30  76.80  78.00  81.70  83.10  77.90  64.70  58.00  47.30   
01001021897  43.70  52.30  61.30  63.00  70.00  82.40  82.40  79.60  76.60  67.40  54.90  48.20   
01001021898  50.10  46.80  60.10  59.60  75.00  81.50  80.80  79.20  76.20  62.10  50.20  44.20   
01001021899  44.60  41.50  56.60  62.30  76.70  81.00  81.00  81.50  74.30  66.60  55.70  45.30 </pre>
                                          <p>
                                                As you can see, the file doesn't have a header so we need to create a list for the column names. The first entry seems to be <code>county FIPS code</code> (5 digits) + <code>02</code> + <code>year</code> with the next 12 entries denoting the monthly average temperatures.
                                          </p>
                                          <p>
                                                I start with creating a list and dictionary for month names:
                                          </p>
                                          <pre class="prettyprint lang-language"><code class="language-python">months = [month for month in month_name][1:]
print(months)
months_dict = dict(zip(months,np.arange(1,13)))
print(months_dict)</code></pre>
                                    <pre>    ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
    {'January': 1, 'February': 2, 'March': 3, 'April': 4, 'May': 5, 'June': 6, 'July': 7, 'August': 8, 'September': 9, 'October': 10, 'November': 11, 'December': 12}</pre>
                                    <p>
                                                The file doesn't have a header so we create a list for the column names
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">WP_df = pd.read_csv('climdiv-tmpccy-v1.0.0-20200106', 
                                 delimiter=r"\s+", 
                                 header=None, 
                                 names = ['FipsYear']+months)
WP_df.head()</code></pre>
                                    <div>
                                          <table class="table table-striped">
                                                <thead>
                                                      <tr style="text-align: left;">
                                                            <th></th>
                                                            <th>FipsYear</th>
                                                            <th>January</th>
                                                            <th>February</th>
                                                            <th>March</th>
                                                            <th>April</th>
                                                            <th>May</th>
                                                            <th>June</th>
                                                            <th>July</th>
                                                            <th>August</th>
                                                            <th>September</th>
                                                            <th>October</th>
                                                            <th>November</th>
                                                            <th>December</th>
                                                      </tr>
                                                </thead>
                                                <tbody>
                                                      <tr>
                                                            <th scope="row">0</th>
                                                            <td>1001021895</td>
                                                            <td>44.000</td>
                                                            <td>38.200</td>
                                                            <td>55.500</td>
                                                            <td>64.100</td>
                                                            <td>70.600</td>
                                                            <td>78.300</td>
                                                            <td>80.400</td>
                                                            <td>80.400</td>
                                                            <td>79.000</td>
                                                            <td>61.400</td>
                                                            <td>54.400</td>
                                                            <td>45.300</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">1</th>
                                                            <td>1001021896</td>
                                                            <td>44.300</td>
                                                            <td>49.000</td>
                                                            <td>54.000</td>
                                                            <td>69.300</td>
                                                            <td>76.800</td>
                                                            <td>78.000</td>
                                                            <td>81.700</td>
                                                            <td>83.100</td>
                                                            <td>77.900</td>
                                                            <td>64.700</td>
                                                            <td>58.000</td>
                                                            <td>47.300</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">2</th>
                                                            <td>1001021897</td>
                                                            <td>43.700</td>
                                                            <td>52.300</td>
                                                            <td>61.300</td>
                                                            <td>63.000</td>
                                                            <td>70.000</td>
                                                            <td>82.400</td>
                                                            <td>82.400</td>
                                                            <td>79.600</td>
                                                            <td>76.600</td>
                                                            <td>67.400</td>
                                                            <td>54.900</td>
                                                            <td>48.200</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3</th>
                                                            <td>1001021898</td>
                                                            <td>50.100</td>
                                                            <td>46.800</td>
                                                            <td>60.100</td>
                                                            <td>59.600</td>
                                                            <td>75.000</td>
                                                            <td>81.500</td>
                                                            <td>80.800</td>
                                                            <td>79.200</td>
                                                            <td>76.200</td>
                                                            <td>62.100</td>
                                                            <td>50.200</td>
                                                            <td>44.200</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">4</th>
                                                            <td>1001021899</td>
                                                            <td>44.600</td>
                                                            <td>41.500</td>
                                                            <td>56.600</td>
                                                            <td>62.300</td>
                                                            <td>76.700</td>
                                                            <td>81.000</td>
                                                            <td>81.000</td>
                                                            <td>81.500</td>
                                                            <td>74.300</td>
                                                            <td>66.600</td>
                                                            <td>55.700</td>
                                                            <td>45.300</td>
                                                      </tr>
                                                </tbody>
                                          </table>
                                    </div>
                                    <pre class="prettyprint lang-language"><code class="language-python">WP_df.dtypes</code></pre>
                                                  <pre>    FipsYear       int64
    January      float64
    February     float64
    March        float64
    April        float64
    May          float64
    June         float64
    July         float64
    August       float64
    September    float64
    October      float64
    November     float64
    December     float64
    dtype: object</pre>
                                    <p>
                                          Note that pandas recognizes the first column to have the type <code>int</code> which might cause some issues later because <strong>the leading zero for the fips numbers starting with 0 has been mistaknely eliminated</strong>. We can resolve this issue in multiple different ways but here, we use the <code class="method">apply()</code> method of <code class="library">Pandas</code> to make the transofrmation. We also split the contents of the first column to two new columns: <code>fips</code> and <code>year</code>.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">WP_df['year']=WP_df['FipsYear'].apply(lambda x: str(x)[-4:])
print(WP_df['year'].head())</code></pre>
                                    <pre>    0    1895
    1    1896
    2    1897
    3    1898
    4    1899
    Name: year, dtype: object</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">WP_df['fips']=WP_df['FipsYear']. \
                           apply(lambda x: '0'+str(x)[:4] if len(str(x))<11 else str(x)[:5])
print(WP_df['fips'].head())</code></pre>
                                    <pre>    0    01001
    1    01001
    2    01001
    3    01001
    4    01001
    Name: fips, dtype: object</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">WP_df.drop(['FipsYear'], axis=1, inplace=True)
WP_df.head()</code></pre>
                                    <div>
                                    <table class="table table-striped">
                                          <thead>
                                                <tr style="text-align: left;">
                                                      <th></th>
                                                      <th>January</th>
                                                      <th>February</th>
                                                      <th>March</th>
                                                      <th>April</th>
                                                      <th>May</th>
                                                      <th>June</th>
                                                      <th>July</th>
                                                      <th>August</th>
                                                      <th>September</th>
                                                      <th>October</th>
                                                      <th>November</th>
                                                      <th>December</th>
                                                      <th>year</th>
                                                      <th>fips</th>
                                                </tr>
                                          </thead>
                                          <tbody>
                                                <tr>
                                                      <th scope="row">0</th>
                                                      <td>44.000</td>
                                                      <td>38.200</td>
                                                      <td>55.500</td>
                                                      <td>64.100</td>
                                                      <td>70.600</td>
                                                      <td>78.300</td>
                                                      <td>80.400</td>
                                                      <td>80.400</td>
                                                      <td>79.000</td>
                                                      <td>61.400</td>
                                                      <td>54.400</td>
                                                      <td>45.300</td>
                                                      <td>1895</td>
                                                      <td>01001</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">1</th>
                                                      <td>44.300</td>
                                                      <td>49.000</td>
                                                      <td>54.000</td>
                                                      <td>69.300</td>
                                                      <td>76.800</td>
                                                      <td>78.000</td>
                                                      <td>81.700</td>
                                                      <td>83.100</td>
                                                      <td>77.900</td>
                                                      <td>64.700</td>
                                                      <td>58.000</td>
                                                      <td>47.300</td>
                                                      <td>1896</td>
                                                      <td>01001</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">2</th>
                                                      <td>43.700</td>
                                                      <td>52.300</td>
                                                      <td>61.300</td>
                                                      <td>63.000</td>
                                                      <td>70.000</td>
                                                      <td>82.400</td>
                                                      <td>82.400</td>
                                                      <td>79.600</td>
                                                      <td>76.600</td>
                                                      <td>67.400</td>
                                                      <td>54.900</td>
                                                      <td>48.200</td>
                                                      <td>1897</td>
                                                      <td>01001</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">3</th>
                                                      <td>50.100</td>
                                                      <td>46.800</td>
                                                      <td>60.100</td>
                                                      <td>59.600</td>
                                                      <td>75.000</td>
                                                      <td>81.500</td>
                                                      <td>80.800</td>
                                                      <td>79.200</td>
                                                      <td>76.200</td>
                                                      <td>62.100</td>
                                                      <td>50.200</td>
                                                      <td>44.200</td>
                                                      <td>1898</td>
                                                      <td>01001</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">4</th>
                                                      <td>44.600</td>
                                                      <td>41.500</td>
                                                      <td>56.600</td>
                                                      <td>62.300</td>
                                                      <td>76.700</td>
                                                      <td>81.000</td>
                                                      <td>81.000</td>
                                                      <td>81.500</td>
                                                      <td>74.300</td>
                                                      <td>66.600</td>
                                                      <td>55.700</td>
                                                      <td>45.300</td>
                                                      <td>1899</td>
                                                      <td>01001</td>
                                                </tr>
                                          </tbody>
                                    </table>
                                    </div>
                                    <h3>Transforming our data into a more convenient format</h3>
                                    <p>
                                          Time Series data are best useful when represented using a <code>timestamp</code>, i.e., a column that represents the temperature for each county using a <code>year-month</code> format. The new <code>DataFrame</code> has five columns: <strong><code>timestamp</code></strong>, <strong><code>temperature</code></strong> (in $^{\circ}\text{F}\,$), fips code, county name, and state name.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">climate_df = pd.DataFrame(columns=['timestamp', 'tempf', 'fips', 'county', 'state'])
                                    climate_df.head()</code></pre>
                                    <div>
                                          <table class="table table-striped">
                                                <thead>
                                                      <tr style="text-align: left;">
                                                            <th></th>
                                                            <th>timestamp</th>
                                                            <th>tempf</th>
                                                            <th>fips</th>
                                                            <th>county</th>
                                                            <th>state</th>
                                                      </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                          </table>
                                    </div>
                                    <h4> Adding fips information to Washington Post data</h4>
                                    <p>
                                          Washington Post data that includes the variation of temperatures over the period 1895-2019 is a county-level data where the counties are represented using their Federal Information Processing Standards (<a href="https://en.wikipedia.org/wiki/Federal_Information_Processing_Standards">FIPS</a>) codes. As we will see later, including the county and state names will be helpful for visualization purposes.
                                    </p>
                                    <p>
                                          We need to find a table that converts these codes to the county/state names before being able to join the two climate dataframes.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">## obtaining the fips table from
                                    ## https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/home/?cid=nrcs143_013697</code></pre>
                                    <p>
                                    <a href="https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/home/?cid=nrcs143_013697">NRCS</a> page has a table including FIPS codes for every county in the US. We use a relatively straightforward way to convert this table into a useful dictionary in <code>Python</code>. First, we need to get the contents of the html page.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">response = requests.get('https://www.nrcs.usda.gov/wps/portal/nrcs/detail/national/home/?cid=nrcs143_013697')</code></pre>
                                    <p>
                                          The most important components of a response to check before moving forward are the <strong>status code</strong> and the <strong>content</strong>.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">response.status_code</code></pre>
                                    <pre>    200</pre>
                                    <p>
                                      We get a response code of <code>200</code>, meaning that our request was 'Successful'!     
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">response.content[:100]</code></pre>
                                    <pre>    b'\r\n\r\n\r\n\r\n \r\n  \r\n\r\n  \r\n\r\n <!DOCTYPE html>\r\n   \r\n\r\n \r\n             \r\n    \r\n      \r\n    \r\n   \r\n \r\n \r\n \r\n'</pre>
                                    <p>
                                          We can check the response <code>text</code> using <a href="https://www.crummy.com/software/BeautifulSoup/"><code>BeautifulSoup</code></a>. <code>BeautifulSoup</code> allows us to find our <code>tag</code> of interest by specifying one of its attributes. By inspecting the <code>table</code> tag in this case we realize that it has and attribute <code>class="data"</code>. Furthermore, <code>SoupStrainer</code> method of the <code>bs4</code> library can be used to limit our search to <code>table</code> tags only.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">soup = BeautifulSoup(response.text,'html.parser',parse_only=SoupStrainer('table'))
table = soup.find("table", { "class" : "data" })
print(table.text[:50])</code></pre>
                                    <pre>FIPS
Name
State
               
01001
Autauga
AL

01003
Bald</pre>
                                    <p>
                                          Looks Ok! Next we want to encapsulate this information into a <code>list()</code> or <code>DataFrame</code>
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">def get_row_data(tr, column_tag='td'):
      return [td.get_text(strip=True) for td in tr.find_all(column_tag)]  

rows = []
trs = table.find_all('tr')
headerow = get_row_data(trs[0], 'th')
for tr in trs: # for every table row
rows.append(get_row_data(tr)) # data row
print(headerow)</code></pre>
                                    <pre>    ['FIPS', 'Name', 'State']</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">rows[1:5]</code></pre>
                                    <pre>    [['01001', 'Autauga', 'AL'],
     ['01003', 'Baldwin', 'AL'],
     ['01005', 'Barbour', 'AL'],
     ['01007', 'Bibb', 'AL']]</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">fips_df_nrcs = pd.DataFrame(rows[1:],columns=['FIPS', 'county', 'state'])
fips_df_nrcs.head()</code></pre>
                                    <div>
                                          <table class="table table-striped">
                                                <thead>
                                                      <tr style="text-align: left;">
                                                            <th></th>
                                                            <th>FIPS</th>
                                                            <th>county</th>
                                                            <th>state</th>
                                                      </tr>
                                                </thead>
                                                <tbody>
                                                      <tr>
                                                            <th scope="row">0</th>
                                                            <td>01001</td>
                                                            <td>Autauga</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">1</th>
                                                            <td>01003</td>
                                                            <td>Baldwin</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">2</th>
                                                            <td>01005</td>
                                                            <td>Barbour</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3</th>
                                                            <td>01007</td>
                                                            <td>Bibb</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">4</th>
                                                            <td>01009</td>
                                                            <td>Blount</td>
                                                            <td>AL</td>
                                                      </tr>
                                                </tbody>
                                          </table>
                                    </div>
                                    <p>
                                        We save the dataframe for later use.  
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">#fips_df_nrcs.to_pickle('fips.pkl')
fips_df_nrcs=pd.read_pickle('fips.pkl')</code></pre>
                                    <h4>Creating a DataFrame suited for Time Series Analysis</h4>
                                    <p>
                                          Now that I have the fips dictionary ready, I have the following plan to populate the DataFrame:
                                    </p>
                                    <ul>
                                    <li>First, I filter the DataFrame rows by fips.</li>
                                    <li>Then, I reshape the month column temperatures into a single-column vector that are temporally ordered</li>
                                    <li>Next, I add a timestamp column that I have generated before. The timestamp column temporally matches the temperatures in the previous column.</li>
                                    <li>Finally, I create an array of ($12\times\text{number of years}$) rows and 3 columns for the fips code, the county name, and the state name.</li>
                                    <li>I repeat the same procedure for the rest of the fips codes.</li>
                                    </ul>
                                    <pre class="prettyprint lang-language"><code class="language-python">WP_df.head()</code></pre>
                                    <div>
                                    <table class="table table-striped">
                                          <thead>
                                                <tr style="text-align: left;">
                                                      <th></th>
                                                      <th>January</th>
                                                      <th>February</th>
                                                      <th>March</th>
                                                      <th>April</th>
                                                      <th>May</th>
                                                      <th>June</th>
                                                      <th>July</th>
                                                      <th>August</th>
                                                      <th>September</th>
                                                      <th>October</th>
                                                      <th>November</th>
                                                      <th>December</th>
                                                      <th>year</th>
                                                      <th>fips</th>
                                                </tr>
                                          </thead>
                                          <tbody>
                                                <tr>
                                                      <th scope="row">0</th>
                                                      <td>44.000</td>
                                                      <td>38.200</td>
                                                      <td>55.500</td>
                                                      <td>64.100</td>
                                                      <td>70.600</td>
                                                      <td>78.300</td>
                                                      <td>80.400</td>
                                                      <td>80.400</td>
                                                      <td>79.000</td>
                                                      <td>61.400</td>
                                                      <td>54.400</td>
                                                      <td>45.300</td>
                                                      <td>1895</td>
                                                      <td>01001</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">1</th>
                                                      <td>44.300</td>
                                                      <td>49.000</td>
                                                      <td>54.000</td>
                                                      <td>69.300</td>
                                                      <td>76.800</td>
                                                      <td>78.000</td>
                                                      <td>81.700</td>
                                                      <td>83.100</td>
                                                      <td>77.900</td>
                                                      <td>64.700</td>
                                                      <td>58.000</td>
                                                      <td>47.300</td>
                                                      <td>1896</td>
                                                      <td>01001</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">2</th>
                                                      <td>43.700</td>
                                                      <td>52.300</td>
                                                      <td>61.300</td>
                                                      <td>63.000</td>
                                                      <td>70.000</td>
                                                      <td>82.400</td>
                                                      <td>82.400</td>
                                                      <td>79.600</td>
                                                      <td>76.600</td>
                                                      <td>67.400</td>
                                                      <td>54.900</td>
                                                      <td>48.200</td>
                                                      <td>1897</td>
                                                      <td>01001</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">3</th>
                                                      <td>50.100</td>
                                                      <td>46.800</td>
                                                      <td>60.100</td>
                                                      <td>59.600</td>
                                                      <td>75.000</td>
                                                      <td>81.500</td>
                                                      <td>80.800</td>
                                                      <td>79.200</td>
                                                      <td>76.200</td>
                                                      <td>62.100</td>
                                                      <td>50.200</td>
                                                      <td>44.200</td>
                                                      <td>1898</td>
                                                      <td>01001</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">4</th>
                                                      <td>44.600</td>
                                                      <td>41.500</td>
                                                      <td>56.600</td>
                                                      <td>62.300</td>
                                                      <td>76.700</td>
                                                      <td>81.000</td>
                                                      <td>81.000</td>
                                                      <td>81.500</td>
                                                      <td>74.300</td>
                                                      <td>66.600</td>
                                                      <td>55.700</td>
                                                      <td>45.300</td>
                                                      <td>1899</td>
                                                      <td>01001</td>
                                                </tr>
                                          </tbody>
                                    </table>
                                    </div>
                                    <h6>Creating the timestamp column</h6>
                                    <pre class="prettyprint lang-language"><code class="language-python">all_years = WP_df.year.unique()
all_months = months
# A little test before going full on
for i, year_month in enumerate(product(all_years[:2], all_months)):
print(pd.to_datetime(year_month[0]+year_month[1], format='%Y%B'))</code></pre>
                                    <pre>    1895-01-01 00:00:00
    1895-02-01 00:00:00
    1895-03-01 00:00:00
    1895-04-01 00:00:00
    1895-05-01 00:00:00
    1895-06-01 00:00:00
    1895-07-01 00:00:00
    1895-08-01 00:00:00
    1895-09-01 00:00:00
    1895-10-01 00:00:00
    1895-11-01 00:00:00
    1895-12-01 00:00:00
    1896-01-01 00:00:00
    1896-02-01 00:00:00
    1896-03-01 00:00:00
    1896-04-01 00:00:00
    1896-05-01 00:00:00
    1896-06-01 00:00:00
    1896-07-01 00:00:00
    1896-08-01 00:00:00
    1896-09-01 00:00:00
    1896-10-01 00:00:00
    1896-11-01 00:00:00
1896-12-01 00:00:00</pre>
                                    <p>
                                          Looks fine! Moving on!
                                    </p>
                                                                  <pre class="prettyprint lang-language"><code class="language-python">timestamps_list = []
for i, year_month in enumerate(product(all_years, all_months)):
timestamps_list.append(pd.to_datetime(year_month[0]+year_month[1], format='%Y%B'))</code></pre>
                                    <p>
                                          Sanity check!
                                    </p>
                                                                  <pre class="prettyprint lang-language"><code class="language-python">assert((2019-1895+1)*12==len(timestamps_list))</code></pre>
                                    <p>
                                          Again, a little test before iterating through the entire rows:
                                    </p>
                                                                  <pre class="prettyprint lang-language"><code class="language-python">climate_df = pd.DataFrame(columns = ['timestamp', 'tempf', 'fips', 'county', 'state'])
climate_df.head()</code></pre>
                                    <div>
                                    <table class="table table-striped">
                                          <thead>
                                                <tr style="text-align: left;">
                                                      <th></th>
                                                      <th>timestamp</th>
                                                      <th>tempf</th>
                                                      <th>fips</th>
                                                      <th>county</th>
                                                      <th>state</th>
                                                </tr>
                                          </thead>
                                          <tbody>
                                          </tbody>
                                    </table>
                                    </div>
                                    <pre class="prettyprint lang-language"><code class="language-python">for i, fips in enumerate(WP_df.fips.unique()[:2]):
    temperature_array = WP_df[WP_df['fips']==fips] \
                                          .iloc[:,:12] \
                                          .values \
                                          .reshape(-1,1)
    fips_array = np.asarray([fips] * len(temperature_array)).reshape(-1,1)
    county_and_state = fips_df_nrcs.set_index('FIPS').loc[fips].to_list()
    county_and_state_array = np.asarray(county_and_state * len(temperature_array)).reshape(-1,2)
    data_array = np.hstack([np.asarray(timestamps_list).reshape(-1,1), 
                            temperature_array, 
                            fips_array, 
                            county_and_state_array])
    tmp_df = pd.DataFrame(data_array, columns = ['timestamp', 'tempf', 'fips', 'county', 'state'])
climate_df = pd.concat([climate_df, tmp_df])</code></pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">climate_df.head()</code></pre>
                                    <div>
                                    <table class="table table-striped">
                                          <thead>
                                                <tr style="text-align: left;">
                                                      <th></th>
                                                      <th>timestamp</th>
                                                      <th>tempf</th>
                                                      <th>fips</th>
                                                      <th>county</th>
                                                      <th>state</th>
                                                </tr>
                                          </thead>
                                          <tbody>
                                                <tr>
                                                      <th scope="row">0</th>
                                                      <td>1895-01-01</td>
                                                      <td>44.000</td>
                                                      <td>01001</td>
                                                      <td>Autauga</td>
                                                      <td>AL</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">1</th>
                                                      <td>1895-02-01</td>
                                                      <td>38.200</td>
                                                      <td>01001</td>
                                                      <td>Autauga</td>
                                                      <td>AL</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">2</th>
                                                      <td>1895-03-01</td>
                                                      <td>55.500</td>
                                                      <td>01001</td>
                                                      <td>Autauga</td>
                                                      <td>AL</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">3</th>
                                                      <td>1895-04-01</td>
                                                      <td>64.100</td>
                                                      <td>01001</td>
                                                      <td>Autauga</td>
                                                      <td>AL</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">4</th>
                                                      <td>1895-05-01</td>
                                                      <td>70.600</td>
                                                      <td>01001</td>
                                                      <td>Autauga</td>
                                                      <td>AL</td>
                                                </tr>
                                          </tbody>
                                    </table>
                                    </div>
                                    <p>
                                          Perfect! Now we can go ahead and create the DataFrame:
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">for i, fips in enumerate(WP_df.fips.unique()[2:]):
    temperature_array = WP_df[WP_df['fips']==fips] \
                                          .iloc[:,:12] \
                                          .values \
                                          .reshape(-1,1)
    fips_array = np.asarray([fips] * len(temperature_array)).reshape(-1,1)
    county_and_state = fips_df_nrcs.set_index('FIPS').loc[fips].to_list()
    county_and_state_array = np.asarray(county_and_state * len(temperature_array)).reshape(-1,2)
    data_array = np.hstack([np.asarray(timestamps_list).reshape(-1,1), 
                            temperature_array, 
                            fips_array, 
                            county_and_state_array])
    tmp_df = pd.DataFrame(data_array, columns = ['timestamp', 'tempf', 'fips', 'county', 'state'])
climate_df = pd.concat([climate_df, tmp_df])</code></pre>
                                    <pre>    ---------------------------------------------------------------------------
    KeyError                                  Traceback (most recent call last)
    ...
KeyError: '02001'</pre>
                                    <p>
                                          Even though the web scraping works fine, it seems like the fips data obtained from the above method lacks a few fips numbers, e.g., <code>'02001'</code>; therefore I use a public dataset from <code class='library'>Plotly</code> to obtain a complete fips data:
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">fips_df_plotly = pd.read_csv("https://raw.githubusercontent.com/plotly/datasets/master/fips-unemp-16.csv", dtype={"fips": str})
fips_df_plotly.head()</code></pre>
                                    <div>
                                    <table class="table table-striped">
                                          <thead>
                                                <tr style="text-align: left;">
                                                      <th></th>
                                                      <th>fips</th>
                                                      <th>unemp</th>
                                                </tr>
                                          </thead>
                                          <tbody>
                                                <tr>
                                                      <th scope="row">0</th>
                                                      <td>01001</td>
                                                      <td>5.300</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">1</th>
                                                      <td>01003</td>
                                                      <td>5.400</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">2</th>
                                                      <td>01005</td>
                                                      <td>8.600</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">3</th>
                                                      <td>01007</td>
                                                      <td>6.600</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">4</th>
                                                      <td>01009</td>
                                                      <td>5.500</td>
                                                </tr>
                                          </tbody>
                                    </table>
                                    </div>
                                    <p>
                                          Comparing it with the initial fips data:
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">len(fips_df_nrcs), len(fips_df_plotly)</code></pre>
                                    <pre>    (3231, 3219)</pre>
                                    <p>
                                          Interestingly, the initial fips data has more entries! Let's compare the fips data in with the union of the two fips datasets that we have obtained so far:
                                    </p>
                                                                  <pre class="prettyprint lang-language"><code class="language-python">len(set(WP_df.fips).difference(set(fips_df_plotly.fips).union(set(fips_df_nrcs.FIPS))))</code></pre>
                                    <pre>    1538</pre>
                                    <p>
                                          Ok! something's definintely wrong! What I do next is that I print the number of unique fips codes for each state (the first two digits in the fips code denotes the state) from the three sources to figure out what causes this discrepancy. My guess is that one dataset has shifted the state codes that causes the mismatch. The maximum and minimum values of the state code are '01'('AL' or 'Alabama') and '78'('VI' or 'Virgin Islands').
                                    </p>
                                                                  <pre class="prettyprint lang-language"><code class="language-python">state_codes = ['0'+f'{x}' if x<10 else f'{x}' for x in range(1,73)]
print(state_codes)</code></pre>
                                    <pre>    ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12', '13', '14', '15', '16', '17', '18', 
    '19', '20', '21', '22', '23', '24', '25', '26', '27', '28', '29', '30', '31', '32', '33', '34', '35', '36', 
    '37', '38', '39', '40', '41', '42', '43', '44', '45', '46', '47', '48', '49', '50', '51', '52', '53', '54', 
    '55', '56', '57', '58', '59', '60', '61', '62', '63', '64', '65', '66', '67', '68', '69', '70', '71', '72']</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">for state_code in state_codes:
    WP_unique_fips = len(WP_df[WP_df['fips'].str.startswith(state_code)]['fips'].unique())
    unique_fips_df_nrcs = len(fips_df_nrcs[fips_df_nrcs['FIPS'].str.startswith(state_code)]['FIPS'].unique())
    unique_fips_df_plotly = len(fips_df_plotly[fips_df_plotly['fips'].str.startswith(state_code)]['fips'].unique())
print(state_code, WP_unique_fips, unique_fips_df_nrcs, unique_fips_df_plotly)</code></pre>
                                    <pre>    01 67 67 67
    02 15 27 29
    03 75 0 0
    04 58 15 15
    05 64 75 75
    06 8 58 58
    07 3 0 0
    08 67 63 64
    09 159 8 8
    10 44 3 3
    11 102 1 1
    12 92 67 67
    13 99 159 159
    14 105 0 0
    15 120 4 4
    16 64 44 44
    17 16 102 102
    18 25 92 92
    19 14 99 99
    20 83 105 105
    21 87 120 120
    22 82 64 64
    23 115 16 16
    24 56 24 24
    25 93 14 14
    26 17 83 83
    27 10 87 87
    28 21 82 82
    29 33 115 115
    30 62 57 56
    31 100 93 93
    32 53 17 17
    33 88 10 10
    34 77 21 21
    35 36 33 33
    36 67 62 62
    37 5 100 100
    38 46 53 53
    39 66 88 88
    40 95 77 77
    41 254 36 36
    42 29 67 67
    43 14 0 0
    44 132 5 5
    45 39 46 46
    46 55 66 66
    47 72 95 95
    48 23 254 254
    49 0 29 29
    50 29 14 14
    51 0 136 133
    52 0 0 0
    53 0 39 39
    54 0 55 55
    55 0 72 72
    56 0 23 23
    57 0 0 0
    58 0 0 0
    59 0 0 0
    60 0 3 0
    61 0 0 0
    62 0 0 0
    63 0 0 0
    64 0 0 0
    65 0 0 0
    66 0 1 0
    67 0 0 0
    68 0 0 0
    69 0 3 0
    70 0 0 0
    71 0 0 0
    72 0 76 78</pre>
                                    <p>
                                          Looks like our suspicion was correct! By visually inspecting the table we can see that except the first row, the numbers in the first column matches the number in the second and third column a few rows apart. We can fix the problem by defining a dictionary that takes the wrong <code>state_code</code>s as keys and returns the correct <code>state_code</code>as values. We also note that the second fips dataset obtained from <code class="library">Plotly</code> better matches with the WP fips codes.
                                    </p>
                                                                  <pre class="prettyprint lang-language"><code class="language-python">state_correction_dict = {}
fips_count_per_state = []
avail_states = []
for state_code in state_codes:
    unique_fips_df_plotly = len(fips_df_plotly[fips_df_plotly['fips'].str.startswith(state_code)]['fips'].unique())
    if unique_fips_df_plotly!=0:
        avail_states.append(state_code)
        fips_count_per_state.append(unique_fips_df_plotly)
fips_dict=dict(zip(avail_states,fips_count_per_state))
for i, state_code in enumerate(state_codes):
    print(state_code+":")
    WP_unique_fips = len(WP_df[WP_df['fips'].str.startswith(state_code)]['fips'].unique())
    if WP_unique_fips!=0:
        if fips_count_per_state.count(WP_unique_fips)==1:
            index = fips_count_per_state.index(WP_unique_fips)
            state_correction_dict[state_code]=avail_states[index]
            print(f'found a matching state! the state code {avail_states[index]} is mistakenly denoted by {state_code}')
        elif fips_count_per_state.count(WP_unique_fips)>1:
            indices = [i for i, e in enumerate(fips_count_per_state) if e == WP_unique_fips]
            print('found multiple matching states!')
            print([avail_states[i] for i in indices])
            state_correction_dict[state_code]=input('which code is the correct one?')
        else:
state_correction_dict[state_code]=input('manually assign the correct code?')</code></pre>
                                    <pre>    01:
    found multiple matching states!
    ['01', '12', '42']
    which code is the correct one?01
    02:
    found a matching state! the state code 04 is mistakenly denoted by 02
    03:
    found a matching state! the state code 05 is mistakenly denoted by 03
    04:
    found a matching state! the state code 06 is mistakenly denoted by 04
    05:
    found multiple matching states!
    ['08', '22']
    which code is the correct one?08
    06:
    found a matching state! the state code 09 is mistakenly denoted by 06
    07:
    found a matching state! the state code 10 is mistakenly denoted by 07
    08:
    found multiple matching states!
    ['01', '12', '42']
    which code is the correct one?12
    09:
    found a matching state! the state code 13 is mistakenly denoted by 09
    10:
    found a matching state! the state code 16 is mistakenly denoted by 10
    11:
    found a matching state! the state code 17 is mistakenly denoted by 11
    12:
    found a matching state! the state code 18 is mistakenly denoted by 12
    13:
    found a matching state! the state code 19 is mistakenly denoted by 13
    14:
    found a matching state! the state code 20 is mistakenly denoted by 14
    15:
    found a matching state! the state code 21 is mistakenly denoted by 15
    16:
    found multiple matching states!
    ['08', '22']
    which code is the correct one?22
    17:
    found a matching state! the state code 23 is mistakenly denoted by 17
    18:
    manually assign the correct code?24
    19:
    found multiple matching states!
    ['25', '50']
    which code is the correct one?25
    20:
    found a matching state! the state code 26 is mistakenly denoted by 20
    21:
    found a matching state! the state code 27 is mistakenly denoted by 21
    22:
    found a matching state! the state code 28 is mistakenly denoted by 22
    23:
    found a matching state! the state code 29 is mistakenly denoted by 23
    24:
    found a matching state! the state code 30 is mistakenly denoted by 24
    25:
    found a matching state! the state code 31 is mistakenly denoted by 25
    26:
    found a matching state! the state code 32 is mistakenly denoted by 26
    27:
    found a matching state! the state code 33 is mistakenly denoted by 27
    28:
    found a matching state! the state code 34 is mistakenly denoted by 28
    29:
    found a matching state! the state code 35 is mistakenly denoted by 29
    30:
    found a matching state! the state code 36 is mistakenly denoted by 30
    31:
    found a matching state! the state code 37 is mistakenly denoted by 31
    32:
    found a matching state! the state code 38 is mistakenly denoted by 32
    33:
    found a matching state! the state code 39 is mistakenly denoted by 33
    34:
    found a matching state! the state code 40 is mistakenly denoted by 34
    35:
    found a matching state! the state code 41 is mistakenly denoted by 35
    36:
    found multiple matching states!
    ['01', '12', '42']
    which code is the correct one?42
    37:
    found a matching state! the state code 44 is mistakenly denoted by 37
    38:
    found a matching state! the state code 45 is mistakenly denoted by 38
    39:
    found a matching state! the state code 46 is mistakenly denoted by 39
    40:
    found a matching state! the state code 47 is mistakenly denoted by 40
    41:
    found a matching state! the state code 48 is mistakenly denoted by 41
    42:
    found multiple matching states!
    ['02', '49']
    which code is the correct one?49
    43:
    found multiple matching states!
    ['25', '50']
    which code is the correct one?50
    44:
    manually assign the correct code?51
    45:
    found a matching state! the state code 53 is mistakenly denoted by 45
    46:
    found a matching state! the state code 54 is mistakenly denoted by 46
    47:
    found a matching state! the state code 55 is mistakenly denoted by 47
    48:
    found a matching state! the state code 56 is mistakenly denoted by 48
    49:
    50:
    found multiple matching states!
    ['02', '49']
    which code is the correct one?02
    51:
    52:
    53:
    54:
    55:
    56:
    57:
    58:
    59:
    60:
    61:
    62:
    63:
    64:
    65:
    66:
    67:
    68:
    69:
    70:
    71:
    72:</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">print(state_correction_dict)</code></pre>
                                    <pre>    {'01': '01', '02': '04', '03': '05', '04': '06', '05': '08', '06': '09', '07': '10', 
     '08': '12', '09': '13', '10': '16', '11': '17', '12': '18', '13': '19', '14': '20', 
     '15': '21', '16': '22', '17': '23', '18': '24', '19': '25', '20': '26', '21': '27', 
     '22': '28', '23': '29', '24': '30', '25': '31', '26': '32', '27': '33', '28': '34', 
     '29': '35', '30': '36', '31': '37', '32': '38', '33': '39', '34': '40', '35': '41', 
     '36': '42', '37': '44', '38': '45', '39': '46', '40': '47', '41': '48', '42': '49', 
     '43': '50', '44': '51', '45': '53', '46': '54', '47': '55', '48': '56', '50': '02'}</pre>
                                    <p>
                                          By inspection, I figured out that even though the state_code 18 with 25 unique fips codes doesn't match any entries from the fips data, because it follows the order of the neighboring rows, I assigned it to the state code 24 with 24 unique fips entries. This means that there's likely to be a fips code that we will have to remove.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">WP_df[WP_df['fips'].str.startswith('18')]['fips'].unique()</code></pre>
                                    <pre>    array(['18001', '18003', '18005', '18009', '18011', '18013', '18015', '18017', '18019', 
     '18021', '18023', '18025', '18027', '18029', '18031', '18033', '18035', '18037', 
     '18039', '18041', '18043', '18045', '18047', '18510', '18511'], dtype=object)</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">fips_df_plotly[fips_df_plotly['fips'].str.startswith('24')]['fips'].unique()</code></pre>
                                    <pre>    array(['24001', '24003', '24005', '24009', '24011', '24013', '24015', '24017', '24019', 
'24021', '24023', '24025', '24027', '24029', '24031', '24033', '24035', '24037', '24039', 
'24041', '24043', '24045', '24047', '24510'], dtype=object)</pre>
                                    <p>
                                          Note that by comparing the two outputs, we notice that <code>fips='24511'</code>, the correct code for the observations with <code>fips='18511'</code>, is not among the in the <code>fips</code> codes. We either need to drop those observations from the climate data or add <code>fips='24511'</code> to the fips DataFrame. We go with the second option. Before adding it to our fips data, we first update the NRCS fips data, <code>fips_df_nrcs</code>, with the fips codes that don't exist in <code>fips_df_nrcs</code> but are tabulated in <code>fips_df_plotly</code>.
                                    </p>
                                    <p>
                                          <strong>fips codes that exist in Plotly data but not in NRCS page.</strong>
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">new_fips_entries = set(fips_df_plotly.fips).difference(set(fips_df_nrcs.FIPS))
new_fips_entries</code></pre>
                                    <pre>    {'02105',
     '02158',
     '02195',
     '02198',
     '02230',
     '02275',
     '08014',
     '46102',
     '72039',
     '72069'}</pre>
                                    <p>
                                          <strong>fips codes that exist in WP data but neither exist in NRCS nor Plotly data.</strong>
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">new_fips_entries.add('24511')</code></pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">for i, fips_code in enumerate(new_fips_entries):
    state = fips_df_nrcs[fips_df_nrcs['FIPS'].str.startswith(fips_code[:2])]['state'].iloc[0]
    fips_df_nrcs = fips_df_nrcs.append({'FIPS': fips_code, 'county':'UNKNOWN', 'state':state}, ignore_index=True)
fips_df_nrcs.tail(15)</code></pre>
                                    <div>
                                          <table class="table table-striped">
                                                <thead>
                                                      <tr style="text-align: left;">
                                                            <th></th>
                                                            <th>FIPS</th>
                                                            <th>county</th>
                                                            <th>state</th>
                                                      </tr>
                                                </thead>
                                                <tbody>
                                                      <tr>
                                                            <th scope="row">3228</th>
                                                            <td>78010</td>
                                                            <td>St. Croix</td>
                                                            <td>VI</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3229</th>
                                                            <td>78020</td>
                                                            <td>St. John</td>
                                                            <td>VI</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3230</th>
                                                            <td>78030</td>
                                                            <td>St. Thomas</td>
                                                            <td>VI</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3231</th>
                                                            <td>01001</td>
                                                            <td>UNKNOWN</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3232</th>
                                                            <td>24511</td>
                                                            <td>UNKNOWN</td>
                                                            <td>MD</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3233</th>
                                                            <td>46102</td>
                                                            <td>UNKNOWN</td>
                                                            <td>SD</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3234</th>
                                                            <td>02158</td>
                                                            <td>UNKNOWN</td>
                                                            <td>AK</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3235</th>
                                                            <td>02195</td>
                                                            <td>UNKNOWN</td>
                                                            <td>AK</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3236</th>
                                                            <td>02198</td>
                                                            <td>UNKNOWN</td>
                                                            <td>AK</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3237</th>
                                                            <td>02230</td>
                                                            <td>UNKNOWN</td>
                                                            <td>AK</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3238</th>
                                                            <td>02105</td>
                                                            <td>UNKNOWN</td>
                                                            <td>AK</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3239</th>
                                                            <td>08014</td>
                                                            <td>UNKNOWN</td>
                                                            <td>CO</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3240</th>
                                                            <td>02275</td>
                                                            <td>UNKNOWN</td>
                                                            <td>AK</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3241</th>
                                                            <td>72039</td>
                                                            <td>UNKNOWN</td>
                                                            <td>PR</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3242</th>
                                                            <td>72069</td>
                                                            <td>UNKNOWN</td>
                                                            <td>PR</td>
                                                      </tr>
                                                </tbody>
                                          </table>
                                    </div>
                                    <h4>Adding the missing FIPS county names</h4>
                                    <p>
                                          Finally, I decided to find the missing counties and add their names to the fips <code>DataFrame</code>. The only fips code that I was unable to find a corresponding county was <code>24511</code>.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">missing_counties_dict = {
'02105':['Hoonah Angoon','AK'],
'02158':['Kusilvak','AK'],
'02195':['Petersburg Borough','AK'],
'02198':['Prince of Wales-Hyder Census Area','AK'],
'02230':['Skagway Municipality','AK'],
'02275':['Wrangell City and Borough' ,'AK'],
'08014':['Broomfield County','CO'],
'72039':['Ciales Municipio','PR'],
'72069':['Humacao Municipio','PR'],
'46102':['Oglala Lakota','SD']
}</code></pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">assert(len(fips_df_nrcs[fips_df_nrcs['county']=='UNKNOWN'])==len(new_fips_entries))
fips_df_nrcs.to_pickle('fips_df_new.pkl') # save
fips_df_nrcs.head()</code></pre>
                                    <div>
                                    <table class="table table-striped">
                                          <thead>
                                                <tr style="text-align: left;">
                                                      <th></th>
                                                      <th>FIPS</th>
                                                      <th>county</th>
                                                      <th>state</th>
                                                </tr>
                                          </thead>
                                          <tbody>
                                                <tr>
                                                      <th scope="row">0</th>
                                                      <td>01003</td>
                                                      <td>Baldwin</td>
                                                      <td>AL</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">1</th>
                                                      <td>01005</td>
                                                      <td>Barbour</td>
                                                      <td>AL</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">2</th>
                                                      <td>01007</td>
                                                      <td>Bibb</td>
                                                      <td>AL</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">3</th>
                                                      <td>01009</td>
                                                      <td>Blount</td>
                                                      <td>AL</td>
                                                </tr>
                                                <tr>
                                                      <th scope="row">4</th>
                                                      <td>01011</td>
                                                      <td>Bullock</td>
                                                      <td>AL</td>
                                                </tr>
                                          </tbody>
                                    </table>
                                    </div>
                                    <p>
                                          Now we repeat the previous loop to construct the DataFrame, however, instead of updating the DataFrame by concatentaing the new DataFrame to it, we append the results to a predefined list as the first approach becomes inefficent for large DataFrames.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">WP_df[WP_df['fips']==wrong_fips] \
.iloc[:,:12].values.reshape(-1,1)</code></pre>
                                    <pre>    array([[28.2],
           [26.4],
           [46. ],
           ...,
           [58.1],
           [41.4],
           [42. ]])</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">climate_df = pd.DataFrame(columns = ['timestamp', 'tempf', 'fips', 'county', 'state'])
num_fips = len(WP_df.fips.unique())
num_years = (2019-1895+1)
num_months = 12
step = 500 # num iterations for timing report 
start_time = datetime.now()
now = start_time
fips_list = []
temps_list = []
county_and_states_list = []
timestamps = []
for i, wrong_fips in enumerate(WP_df.fips.unique()):
    # wrong_fips is ok for looking up the temperatures
    temps =  WP_df[WP_df['fips']==wrong_fips] \
                                          .iloc[:,:12] \
                                          .values \
                                          .reshape(-1,1)
    correct_fips = state_correction_dict[wrong_fips[:2]]+wrong_fips[2:]
    temps_list.extend(temps)
    fips_list.extend([correct_fips] * len(temps))
    county_and_state = fips_df_nrcs.set_index('FIPS').loc[correct_fips].to_list()
    county_and_states_list.extend(county_and_state * len(temps))
    # Temperature data for a few counties does not cover the entire 1895-2019 range
    if len(temps)!=1500:
        timestamps_=[]
        years_ = WP_df[WP_df['fips']==wrong_fips].year.unique()
        for i, year_month in enumerate(product(years_, all_months)):
            timestamps_.append(pd.to_datetime(year_month[0]+year_month[1], format='%Y%B'))
        timestamps.extend(timestamps_)
    else:
        timestamps.extend(timestamps_list)
    if i%step==0:
        print(f"processing the past {step} fips codes took {(datetime.now()-now).total_seconds():.2f} seconds")
        print(f"total time spent so far is {(datetime.now()-start_time).total_seconds():.2f} seconds")
        print(f'{num_fips-i} fips_code remain to be processed!')
now = datetime.now()</code></pre>
                                    <pre>    processing the past 500 fips codes took 0.04 seconds
    total time spent so far is 0.05 seconds
    3136 fips_code remain to be processed!
    processing the past 500 fips codes took 11.80 seconds
    total time spent so far is 11.85 seconds
    2636 fips_code remain to be processed!
    processing the past 500 fips codes took 11.16 seconds
    total time spent so far is 23.00 seconds
    2136 fips_code remain to be processed!
    processing the past 500 fips codes took 11.90 seconds
    total time spent so far is 34.90 seconds
    1636 fips_code remain to be processed!
    processing the past 500 fips codes took 28.75 seconds
    total time spent so far is 63.65 seconds
    1136 fips_code remain to be processed!
    processing the past 500 fips codes took 11.99 seconds
    total time spent so far is 75.64 seconds
    636 fips_code remain to be processed!
    processing the past 500 fips codes took 10.69 seconds
    total time spent so far is 86.33 seconds
    136 fips_code remain to be processed!</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">data_array = np.hstack([np.reshape(timestamps,(-1,1)),  
                        np.reshape(temps_list,(-1,1)), 
                        np.reshape(fips_list,(-1,1)), 
                        np.reshape(county_and_states_list,(-1,2))])
climate_df = pd.DataFrame(data_array, columns = ['timestamp', 'tempf', 'fips', 'county', 'state'])</code></pre>
                                    <p>
                                          Since the number of counties with missing data wete not that many and for the sake of completeness, I decided to manually add the UNKNOWN county names. I realized some county names are missing because they have either been modified or recently (after 2015) been added to FIPS data. Here's what I found:  
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">missing_counties_dict = {
'02105':['Hoonah Angoon','AK'],
'02158':['Kusilvak','AK'],
'02195':['Petersburg Borough','AK'],
'02198':['Prince of Wales-Hyder Census Area','AK'],
'02230':['Skagway Municipality','AK'],
'02275':['Wrangell City and Borough' ,'AK'],
'08014':['Broomfield County','CO'],
'72039':['Ciales Municipio','PR'],
'72069':['Humacao Municipio','PR'],
'46102':['Oglala Lakota','SD']
}

for k,v in missing_counties_dict.items():
    row_index = climate_df[climate_df['fips']==k].index
    climate_df.loc[row_index,'county'] = v[0]

climate_df.head()</code></pre>
                                    <div>
                                          <table class="table table-striped">
                                                <thead>
                                                      <tr style="text-align: left;">
                                                            <th></th>
                                                            <th>timestamp</th>
                                                            <th>tempf</th>
                                                            <th>fips</th>
                                                            <th>county</th>
                                                            <th>state</th>
                                                      </tr>
                                                </thead>
                                                <tbody>
                                                      <tr>
                                                            <th scope="row">0</th>
                                                            <td>1895-01-01</td>
                                                            <td>44.000</td>
                                                            <td>01001</td>
                                                            <td>Autauga</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">1</th>
                                                            <td>1895-02-01</td>
                                                            <td>38.200</td>
                                                            <td>01001</td>
                                                            <td>Autauga</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">2</th>
                                                            <td>1895-03-01</td>
                                                            <td>55.500</td>
                                                            <td>01001</td>
                                                            <td>Autauga</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3</th>
                                                            <td>1895-04-01</td>
                                                            <td>64.100</td>
                                                            <td>01001</td>
                                                            <td>Autauga</td>
                                                            <td>AL</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">4</th>
                                                            <td>1895-05-01</td>
                                                            <td>70.600</td>
                                                            <td>01001</td>
                                                            <td>Autauga</td>
                                                            <td>AL</td>
                                                      </tr>
                                                </tbody>
                                          </table>
                                    </div>
                                    <p>
                                          Finally, before saving the data, let's transform the data types into correct format.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">climate_df.dtypes</code></pre>
                                    <pre>    timestamp    datetime64[ns]
    tempf                object
    fips                 object
    county               object
    state                object
    dtype: object</pre>
                                    <pre class="prettyprint lang-language"><code class="language-python">climate_df['tempf'] = climate_df['tempf'].astype(float)
climate_df['fips'] = climate_df['fips'].astype(str)
climate_df['county'] = climate_df['county'].astype(str)
climate_df['state'] = climate_df['state'].astype(str)

# save
climate_df.to_pickle('WP_climate_data.pkl')</code></pre>
                                    <p>
                                          Great! Now that we are done with data cleaning, we can start <strong>Time Series forecasting</strong>!
                                    </p>
                                    <h2>Time Series Analysis</h2>
                                    <p>
                                          <strong>Time series forecasting</strong> or prediction presents a different problem compared to other ML problems in that it <strong>introduces a time dimension</strong>. All the features in every observation row in a Time Series data have one thing in common; <strong>They have been observed at the same time</strong>. We can think of time as the index of our DataFrame as it orders the observations <strong>temporally</strong>.
                                    </p>
                                    <p>
                                          The goal of Time Series prediction is to <strong>make predictions for some time in Future</strong>. Due to the <strong>temporal and periodic nature of the time</strong>, Time Series models usually incorporate different methods to capture different time-scales. For instance, <em>long-time <strong>"trends"</strong>, AKA <strong>"drift"</strong></em>, <em>periodic trends, AKA <strong>"seasonality"</strong></em>, and the <em><strong>"residual noise"</strong></em> are modeled using different mesthods and assumptions that best fits that aspect of the time component.
                                    </p>
                                    <h3>Making Predictions</h3>
                                    <p>
                                          When predicting a variable in future, we need to have a good understanding about the temporal nature of the target variable. Some of the questions that we might want to aske ourselves before attempting to design a model are:
                                    </p>
                                    <ul>
                                    <li>What is the resolution of the data that we have? Is it yearly, monthly, weekly etc.</li>
                                    <li>How much data do we have? 1 year? 1 decade? ...</li>
                                    <li>What is the time window that we would like th emodel to predict? Is it the next day? Short term? Long term? ...</li>
                                    <li>Will we update the data that we have or is it going to be used just one time?</li>
                                    </ul>
                                    Answering these questions can really help deciding on what model to use and what are the advantages and disadvantages.
                                    <h3>Model Validation</h3>
                                    <p>
                                          As one might intuitively think, the model validation is going to be slightly different from the common validation techniques used in ML in that all the observations in the validation data has to correspond to some time after the most recent observation in the training data. It is important to take into account the potential relationships between the observations, e.g., seasonal, monthly, or hourly correlations to make the most accurate model.
                                    </p>
                                    <h3>Applications</h3>
                                    <p>
                                          Time Series models can be applied to a lot of problems in different areas, for example:
                                    </p>
                                    <ul>
                                    <li>Forecasting the BitCoin price</li>
                                    <li>Forecasting the weather</li>
                                    <li>Forecasting the traffic</li>
                                    <li>Forecasting the housing price</li>
                                    <li>Forecasting the percipitation</li>
                                    <li>...</li>
                                    </ul>
                                    <h3>Modeling Different components of a Time Series</h3>
                                    <p>
                                          A time series data $X_t$ can be expressed as the sum of <strong>drift</strong>, <strong>seasonal</strong>, and <strong>noise</strong> components:
                                    
$$
X_t = X_{d,t} + X_{s,t} + X_{n,t},
$$
                                    where $t$ denotes the time index. We aim to develop a mathematical model for each of these constituents so that we can make prediction sthe series in future times.
                                    </p>
                                    <h4> Modeling the general trend, AKA "drift"</h4>
                                    <p>
                                          The general, long term time series behavior is referred to as <strong>trend</strong>. The best way to check the presence of such behavior is to look at the series in a long period of time. For instance, we can take a look at <strong>the average temperature of Pennsylvania</strong> from 1895-2019. We use <strong>annual average</strong>, <strong>seasonal average</strong>, and <strong>monthly data</strong> to plot the temperature variation in three different time scales</strong> and use that data to calcualte the best linear fit.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">fig, ax = plt.subplots(3,1,figsize=(12,12),dpi=80)
plt.subplots_adjust(left=0, bottom=0, right=1, top=1, wspace=0, hspace=0.25)
state = 'PA'
state_df = climate_df[climate_df['state']==state]
# Set the timestamp as index
state_df.set_index('timestamp', inplace=True)
year_min = state_df.index.year.min()
year_max = state_df.index.year.max()
# We define an lookup array that given the month index (1, 2, ...), returns the season
month_to_season_arr = np.array([
    None,
    'Winter', 'Winter',
    'Spring', 'Spring', 'Spring',
    'Summer', 'Summer', 'Summer',
    'Fall', 'Fall', 'Fall',
    'Winter'
])
season_groupby = month_to_season_arr[state_df.index.month]
groupby_list = [
    [(state_df.index.year)], 
    [(state_df.index.year), season_groupby], 
    [(state_df.index.year),(state_df.index.month)]
]
titles = ['Annual', 'Seasonal', 'Monthly']
for i,ax_ in enumerate(ax):
    state_df.groupby(groupby_list[i]).mean().plot(ax=ax_)
    ax_.set_xlabel('')
    ax_.legend([]) # remove the legends
    ax_.set_title(f'{titles[i]} average temperature ($^\circ$F) in {state} from {year_min} to {year_max}', 
                  fontsize=18)
</code></pre>
                                    <div style="text-align:center">
                                          <a id="fig1" style="font-size: 1.5em;">Figure 1</a>
                                    </div>
                                    <p style="text-align: center;">
                                      <img src="output_91_0.png" style="width: 90%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <p>
                                          Notice the <strong>linear</strong> upward trend in temperatures from 1895 to 2019 in <a href="#fig1">Figure 1</a>. Also notice that the higher resolution, e.g. plotting monthly instead of yearly, makes visualizing the general trends more difficult. This makes sense because annual temperature averages fluctuate far less than monthly data. This is not quite true when we compare the seasonal and monthly plots because the monthly temperatures does not vary significantly in a season; therefore, seasonal averages remain close to the monthly temperatures in the months belonging to that seaoson.
                                    </p>
                                    <p>
                                          Had we plotted the series in a shorter time-period, we might not have been able to notice this trend. For instance, taking a look at the last 30 years instead of the entire time period shows:
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">fig, ax = plt.subplots(1,1,figsize=(12, 4),dpi=300)
last_many_years = 30
state_df.groupby(state_df.index.year).mean()[-last_many_years:].plot(ax=ax, marker='o')
ax.set_xlabel('')
ax.legend([])
ax.set_title(f'{titles[0]} average temperature ($^\circ$F) in {state} from {year_max-last_many_years} to {year_max}', 
fontsize=14);</code></pre>
                                    <div style="text-align:center">
                                          <a id="fig2" style="font-size: 1.5em;">Figure 2</a>
                                    </div>
                                    <p style="text-align: center;">
                                      <img src="output_93_0.png" style="width: 90%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <p>
                                          Therefore, revealing the long-time trend in time seties data requires data from some time significantly far in the past. In the next part, <strong>we will go through the common ways that we can model the trend</strong>.
                                    </p>
                                    <h4>Modeling trend using linear regression</h4>
                                    <p>
                                          For the sake of convenience, I use the <code class="module">LinearRegression()</code> module of <code class="library">sklearn</code> to find the best linear fit to the time series data. We use the same data from previous part (Annual temperature averages of PA).
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">linear_model_y = LinearRegression(normalize=True, fit_intercept=True) 
x_data_y = state_df.index.year.unique().values.reshape(-1,1)
y_data_y = state_df.groupby(state_df.index.year).mean()
linear_model_y.fit(x_data_y, y_data_y) 
print(f'linear coefficient={linear_model_y.coef_[0][0]:.4f} and intercept={linear_model_y.intercept_[0]:.2f} ')</code></pre>
                                    <pre>    linear coefficient=0.0150 and intercept=19.24 </pre>
                                    <p>
                                          Similarly, we can use the monthly data for linear regression:
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">linear_model_m = LinearRegression(normalize=True, fit_intercept=True) 
y_data_m = state_df.groupby([(state_df.index.year),(state_df.index.month)]).mean()
x_data_m = np.linspace(1895, 2019, len(y_data_m)).reshape(-1,1)
linear_model_m.fit(x_data_m, y_data_m) 
print(f'linear coefficient={linear_model_m.coef_[0]:.4f} and intercept={linear_model_m.intercept_:.2f}')</code></pre>
                                    <pre>    linear coefficient=0.0161 and intercept=17.05</pre>
                                    <p>
                                          Notice the slight difference between the two fits. We can visualize the overlay of the linear model prediction and the actual data. The linear model represents the drift constituent of the time series model, $X_{d,t}$
                                    </p>
                                                                  <pre class="prettyprint lang-language"><code class="language-python">sns.set(rc={'axes.facecolor':'whitesmoke', 'figure.facecolor':'gainsboro', 'legend.facecolor':'white'})
fig, ax = plt.subplots(2, 1, figsize=(12, 8), dpi=300)
plt.subplots_adjust(left=0, bottom=0, right=1, top=1, wspace=0, hspace=0.4)
a_y, b_y = linear_model_y.coef_[0][0], linear_model_y.intercept_[0] # f(x) = a.x + b (year)
a_m, b_m = linear_model_m.coef_[0], linear_model_m.intercept_ # f(x) = a.x + b (month)
y_pred_y = a_y*x_data_y + b_y
y_pred_m = a_m*x_data_m + b_m
y_data = [y_data_y, y_data_m]
x_data = [x_data_y, x_data_m]
y_pred = [y_pred_y, y_pred_m]
titles = ['Annual', 'Monthly']
for i, ax_ in enumerate(ax):
    ax_.plot(x_data[i], y_data[i], color='deepskyblue', linestyle='-', label='data')
    ax_.plot(x_data[i], y_pred[i], color='maroon', linestyle='--', label='linear fit')
    ax_.set_xlabel('year', fontsize=18, labelpad=10)
    ax_.set_ylabel('temperature ($^\circ$F)', fontsize=18, labelpad=10)
    if i==0:
        ax_.legend(bbox_to_anchor=(1,1,0,0), fontsize=14, loc='upper left');
    ax_.set_title(f'Linear fit of time series (using {titles[i]} data)', fontsize=22);
    ax_.set_xlim([1894, 2020])
    ax_.grid(False)
    plt.setp(ax_.get_xticklabels(), fontsize=14)
plt.setp(ax_.get_yticklabels(), fontsize=14)</code></pre>
                                    <div style="text-align:center">
                                          <a id="fig3" style="font-size: 1.5em;">Figure 3</a>
                                    </div>
                                    <p style="text-align: center;">
                                      <img src="output_99_0.png" style="width: 90%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <p>
                                          Now that we know how to model long time behavior of the temperature, we can start visualizing the temperature data to see if we can gain any insights using this extremely simple model. 
                                    </p>
                                    <h4>Visualizing the temperature variations in different US regions</h4>
                                    <p>
                                          Let's take a look at the temperature variations in <strong>New England</strong> (sorry!) states, i.e., <em>Connecticut</em>, <em>Maine</em>, <em>Massachusetts</em>, <em>New Hampshire</em>, <em>Rhode Island</em>, and <em>Vermont</em>.
                                    </p>
                                    <div style="text-align:center">
                                          <a id="fig4" style="font-size: 1.5em;">Figure 4 - US map</a>
                                    </div>
                                    <p style="text-align: center;">
                                          <img src="us_states.png" style="width: 70%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    
                                    <pre class="prettyprint lang-language"><code class="language-python">fig, ax = plt.subplots(1,1,figsize=(12,6),dpi=100)
states_list = ['MA', 'RI', 'CT', 'ME', 'NH', 'VT']
temp_unit = 'F' # 'C' for Celsius or 'F' for farenheit

for state in states_list:
    state_df = climate_df[climate_df['state']==state].set_index("timestamp")
    means = state_df.groupby(state_df.index.year) \
                    .agg({'temp'+temp_unit.lower(): 'mean'})
    years = means.index.tolist()
    ax.plot(years, means, label=state)
ax.set_xlabel('year', labelpad=10, fontsize=18)
ax.set_ylabel(f'Temperature ($^\circ${temp_unit})', labelpad=15, fontsize=18)
states = ', '.join([state for state in states_list])
ax.set_title(f'Temperature variation over the period {min(years)}-{max(years)} for \n{states}', 
             fontsize=22, y=1.02)
plt.setp(ax.get_xticklabels(), fontsize=14)
plt.setp(ax.get_yticklabels(), fontsize=14)
ax.legend(bbox_to_anchor=(1, 0, 0.1, 1), loc='upper left', fontsize=14);</code></pre>
                                    <div style="text-align:center">
                                          <a id="fig5" style="font-size: 1.5em;">Figure 5</a>
                                    </div>
                                    <p style="text-align: center;">
                                      <img src="output_1.png" style="width: 90%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <p>
                                          Notice that we see two distinct groups of states in <a href="#fig5">Figure 5</a>, the Northern(<em>'NH'</em>, <em>'ME'</em>, and <em>'VT'</em>) and Southern(<em>'CT'</em>, <em>'MA'</em>, and <em>'RI'</em>) New England states.
                                    </p>
                                    <p>
                                          I wrapped the code above in a function to display the temperature variations for a state or group of states, where the states are color coded by their mean temperature. 
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">def plot_ts_temp(df, states_list, ax=None, 
                 figsize=(15,10), dpi=300, cmap='coolwarm', 
                 temp_unit = 'F', lbfs=18, lbpdx=10, lbpdy=15,
                 ttlfs=22, tckfs=14, title='', xlab='year'):
    colors = col_to_hex(cmap, n=len(states_list))
    # mean temp over time. we use this to sort the states_list by temperature
    means_df = df.query("state in @states_list").groupby(climate_df.state).agg('mean')
    soted_by_temp_states = means_df.index[np.argsort(temps.reshape(1,-1))][0]
    if ax is None:
        fig=plt.figure(figsize=figsize, dpi=dpi)
        ax = fig.add_subplot(111)
    temp_unit = 'F' # 'C' for Celsius or 'F' for farenheit
    print(soted_by_temp_states)
    for i,state in enumerate(soted_by_temp_states):
        state_df = df[df['state']==state].set_index('timestamp')
        means = state_df.groupby(state_df.index.year) \
                        .agg({'temp'+temp_unit.lower(): 'mean'})
        years = means.index.tolist()
        ax.plot(years, means, label=state, color=colors[i])
    ax.set_xlabel(xlab, labelpad=lbpdx, fontsize=lbfs)
    ax.set_ylabel(f'Temperature ($^\circ${temp_unit})', labelpad=lbpdy, fontsize=lbfs)
    states = ', '.join([state for state in states_list])
    if title is not None:
        ax.set_title(f'Temperature variation over the period {min(years)}-{max(years)} for \n{states}', 
                     fontsize=ttlfs, y=1.02)
    plt.setp(ax.get_xticklabels(), fontsize=tckfs)
    plt.setp(ax.get_yticklabels(), fontsize=tckfs)
    ax.legend(bbox_to_anchor=(1, 0, 0.1, 1), loc='upper left', fontsize=tckfs)</code></pre>
                                    <p>
                                          This time, let's take a look at East North Central states, i.e., <em>Illinois</em>, <em>Indiana</em>, <em>Michigan</em>, <em>Ohio</em>, and <em>Wisconsin</em>.
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">plot_ts_temp(climate_df, ['IL', 'IN', 'MI', 'OH', 'WI'])</code></pre>
                                    <div style="text-align:center">
                                          <a id="fig6" style="font-size: 1.5em;">Figure 6</a>
                                    </div>
                                    <p style="text-align: center;">
                                          <img src="output_2.png" style="width: 90%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <p>
                                          <a href="#fig6">Figure 6</a> shows something similar to what we saw in <a href="#fig5">Figure 5</a>, where the temperature variations for East North Central states are further divided into two groups of states, the Northern (<em>WI</em> and <em>MI</em>) and Southern states (<em>IL</em>, <em>IN</em>, and <em>OH</em>) of the region.
                                    </p>
                                    <p>
                                          Finally, plotting the two groups of states, New England and East North Central states together. 
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">fig, ax = plt.subplots(1,1,figsize=(8,8),sharex=True)
plot_ts_temp(climate_df, ['IL', 'IN', 'MI', 'OH', 'WI', 'MA', 'RI', 'CT', 'ME', 'NH', 'VT'], 
             ax=ax, title=None, cmap='coolwarm', xlab='year')</code></pre>
                                    <div style="text-align:center">
                                          <a id="fig7" style="font-size: 1.5em;">Figure 7</a>
                                    </div>
                                    <p style="text-align: center;">
                                          <img src="output_3.png" style="width: 90%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <p>
                                          As one might have expected, the Northern and Southern states belonging to the two regions are now adjacent plots in <a href="#fig7">Figure 7</a> where we can see a distinct gap between the Northern (<em>'NH'</em>, <em>'ME'</em>, <em>'VT'</em>, <em>WI</em> and <em>MI</em>) and Southern (<em>'CT'</em>, <em>'MA'</em>, <em>'RI'</em>, <em>IL</em>, <em>IN</em>, and <em>OH</em>)states of the union of the two regions. 
                                    </p>
                                    <h4>Visualizing temperature heatmaps using <code>Plotly</code></h4>
                                    <p>
                                          <code>Plotly</code>'s <code>Coropleth</code> maps are an efficient, beautiful way of representing and analyzing the spatial variation of a quntity. In addition, if we split our time series data into separate groups, e.g., monthly aggregates, <code>Plotly</code>'s <code>slider</code> element can be used to look into the variation of temperature at different months, seasons etc.
                                    </p>
                                    <p>
                                          In this part of the project, I will first go through visualizing the mean temperatures using <code>Plotly</code> and then, I'll demonstrate how the <code>slider</code> element can be used to explore the temperatures and temperature variation rates at different scales, e.g., state-level, county-level etc.
                                    </p>
                                    <h4>state-level temperatures in 2019</h4>
                                    <pre class="prettyprint lang-language"><code class="language-python"># mean state temperature in 2019
state_avg_temp_2019 = climate_df[climate_df['timestamp'].dt.year==2019]. \
                      groupby('state')['tempf'].agg('mean')
state_avg_temp_2019 = state_avg_temp_2019.reset_index()
state_avg_temp_2019.head()code></pre>
residual_data.head()</code></pre>
                                    <div>
                                          <table class="table table-striped">
                                                <thead>
                                                      <tr style="text-align: left;">
                                                            <th></th>
                                                            <th>state</th>
                                                            <th>tempf</th>
                                                      </tr>
                                                </thead>
                                                <tbody>
                                                      <tr>
                                                            <th scope="row">0</th>
                                                            <td>AK</td>
                                                            <td>36.110</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">1</th>
                                                            <td>AL</td>
                                                            <td>65.165</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">2</th>
                                                            <td>AR</td>
                                                            <td>61.176</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3</th>
                                                            <td>AZ</td>
                                                            <td>61.758</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">4</th>
                                                            <td>CA</td>
                                                            <td>57.551</td>
                                                      </tr>
                                                </tbody>
                                          </table>
                                    </div>
                                    <p>
                                          <code>Choropleth</code> maps use
                                          <ul>
                                                <li>
                                                      a <code>data</code> dictionary that contains the data about the variable to be plotted as well as some geometrical attributes regarding the locations in which the data belong to
                                                </li>
                                                <li>
                                                      a <code>layout</code> dictionary that controls the appearance of the map onto which data is plotted.
                                                </li>
                                          </ul>
                                    </p>
                                    <p>
                                          The following piece of code plots the average state temperatures in 2019.
                                    </p>
                                    <button class="btn btn-primary plus-minus-code collapsed" type="button" data-toggle="collapse" data-target="#code1" aria-expanded="false" aria-controls="code1"></button>  
                                    <div class="collapse" id="code1" aria-expanded="false" style="height: 0px;">
                                          <pre class="prettyprint lang-language"><code class="language-python">from urllib.request import urlopen
import json
with urlopen('https://raw.githubusercontent.com/plotly/datasets/master/geojson-counties-fips.json') as response:
    counties = json.load(response)
    
data = dict(
            type='choropleth', # type of map-plot
            colorbar = dict(
                            x=0.9, #x-location of the colorbar wrt to (0,0)
                            title=dict(text="T (&#38;deg;F)",
                                       font=dict(size=20)),
                            tickformat=".0f", 
                            tickfont=dict(size=20)
            ), # colorbar title and tick format
            geojson=counties, # GeoJSON data 
            locationmode="USA-states", # for state-level graphs
            name='', # gets rid of the word 'trace' appearing when hover
            locations = state_avg_temp_2019['state'], # the state column
            z = np.round(state_avg_temp_2019['tempf'], 2), # the heatmap variable
            zmax=max_temp, # max temperature
            zmin=min_temp, # min temperature
            autocolorscale = False
           )
layout = dict(
              title=dict(
                         text = "State-level temperature heatmap in 2019", 
                         x=0.5, 
                         font=dict(size=30),
                        ), # title and location adjustment
              geo = dict(
                         scope='usa',
                         projection=dict(type='albers usa')
                        )
             )
fig=go.Figure(data=data,layout=layout)
fig.update_traces(marker_line_width=0)
# overlay a scatter plot showing the state names!
fig.add_scattergeo(locations=state_avg_temp_2019['state'],
                   locationmode='USA-states',
                   text=state_avg_temp_2019['state'],
                   mode='text',
                   showlegend = False,
                   hoverinfo='none', 
                   textfont={'color':'white', 
                             'size':20})

# pdf format generates the highest quality!
pio.write_image(fig, 'state_temps_2019.pdf', width=2000, height=1000)
iplot(fig)</code></pre></div>
                                    <div style="text-align:center">
                                          <a id="code1fig" style="font-size: 1.5em;">Figure 8</a>
                                    </div>
                                    <p style="text-align: center;">
                                          <img src="state_temps_2019.png" style="width: 100%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <h4>county-level temperatures in 2019</h4>
                                    <p>
                                          We can reproduce <a href="#code1fig">Figure 8</a> in greater detail by calculating the mean temperatures for every county instead of every state. 
                                    </p>
                                    <pre class="prettyprint lang-language"><code class="language-python">county_avg_temp_2019 = climate_df[climate_df['timestamp'].dt.year==2019]. \
                       groupby(['fips','county','state'])['tempf'].agg('mean')
county_avg_temp_2019 = county_avg_temp_2019.reset_index()
county_avg_temp_2019.head()</code></pre>
                                    <div>
                                          <table class="table table-striped">
                                                <thead>
                                                      <tr style="text-align: left;">
                                                            <th></th>
                                                            <th>fips</th>
                                                            <th>county</th>
                                                            <th>state</th>
                                                            <th>tempf</th>
                                                      </tr>
                                                </thead>
                                                <tbody>
                                                      <tr>
                                                            <th scope="row">0</th>
                                                            <td>01001</td>
                                                            <td>Autauga</td>
                                                            <td>AL</td>
                                                            <td>366.608</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">1</th>
                                                            <td>01003</td>
                                                            <td>Baldwin</td>
                                                            <td>AL</td>
                                                            <td>68.792</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">2</th>
                                                            <td>01005</td>
                                                            <td>Barbour</td>
                                                            <td>AL</td>
                                                            <td>67.133</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">3</th>
                                                            <td>01007</td>
                                                            <td>Bibb</td>
                                                            <td>AL</td>
                                                            <td>64.746</td>
                                                      </tr>
                                                      <tr>
                                                            <th scope="row">4</th>
                                                            <td>01009</td>
                                                            <td>Blount</td>
                                                            <td>AL</td>
                                                            <td>63.583</td>
                                                      </tr>
                                                </tbody>
                                          </table>
                                    </div>
                                    <button class="btn btn-primary plus-minus-code collapsed" type="button" data-toggle="collapse" data-target="#code2" aria-expanded="false" aria-controls="code2"></button>  
                                    <div class="collapse" id="code2" aria-expanded="false" style="height: 0px;">
                                          <pre class="prettyprint lang-language"><code class="language-python">min_temp, max_temp = county_avg_temp_2019.describe()['tempf'][['min', 'max']].values
data = dict(
            type='choropleth', # type of map-plot
            colorbar = dict(
                            x=0.9, #x-location of the colorbar wrt to (0,0)
                            title=dict(text="T (&#38;deg;F)",
                                       font=dict(size=20)),
                            tickformat=".0f", 
                            tickfont=dict(size=20)
            ), # colorbar title and tick format
            geojson=counties, # GeoJSON data 
            name='', # gets rid of the word 'trace' appearing when hover
            locations = county_avg_temp_2019['fips'], # fips
            z = np.round(county_avg_temp_2019['tempf'], 2), # the heatmap variable
            zmax=max_temp, # max temperature
            zmin=min_temp, # min temperature
            text=county_avg_temp_2019['county']+' ('+county_avg_temp_2019['state']+')',
            autocolorscale = False
           )
layout = dict(
              title=dict(
                         text = "County-level temperature heatmap in 2019", 
                         x=0.5, 
                         font=dict(size=30),
                        ), # title and location adjustment
              geo = dict(
                         scope='usa',
                         projection=dict(type='albers usa')
                        )
             )
fig=go.Figure(data=data,layout=layout)
fig.update_traces(marker_line_width=0)
pio.write_image(fig, 'county_temps_2019.pdf', width=2000, height=1000)
iplot(fig)</code></pre></div>
                                    <div style="text-align:center">
                                          <a id="code2fig" style="font-size: 1.5em;">Figure 9</a>
                                    </div>
                                    <p style="text-align: center;">
                                          <img src="county_temps_2019.png" style="width: 100%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <p style="text-align: center;  margin: 10px auto 20px;">
                                          County-level temperature variation rate in US in <span id="month" style="font-weight:bold;"></span> (°F per 100 years)
                                    </p>
                              </div>
                              <div class="col-lg-2"></div>

                              <div class="col-lg-10">
                                    <p class="text-align: center;">
                                          <img src="temperature_rates_heatmap_January-1.png" id="slider-month-image" style="width: 100%; display: block; margin: 10px auto 20px;"/>
                                    </p>
                                    <div>
                                          <p>
                                                <input type="range" min="0" max="11" value="0" id="rangeslider" list="month-values">
                                                <datalist id="month-values" >
                                                <option label="Jan">0</option>
                                                <option label="Feb">1</option>
                                                <option label="Mar">2</option>
                                                <option label="Apr">3</option>
                                                <option label="May">4</option>
                                                <option label="Jun">5</option>
                                                <option label="Jul">6</option>
                                                <option label="Aug">7</option>
                                                <option label="Sep">8</option>
                                                <option label="Oct">9</option>
                                                <option label="Nov">10</option>
                                                <option label="Dec">11</option>
                                                </datalist>
                                          </p>
                                          <script>
                                                var monthNames = ["January", "February", "March",
                                                "April", "May", "June", "July",
                                                "August", "September", "October",
                                                "November", "December"
                                                ];
                                                var slideCol = document.getElementById("rangeslider");
                                                var y = document.getElementById("month");
                                                var month_id = slideCol.value;
                                                y.innerHTML = monthNames[month_id]    
                                                slideCol.oninput = function() {
                                                month_id = this.value;
                                                y.innerHTML = monthNames[month_id];
                                                document.getElementById("slider-month-image").src = ['temperature_rates_heatmap_', monthNames[month_id], '-1.png'].join('');
                                                }
                                          </script>
                                    </div>
                              </div>
                              <div class="col-lg-2">
                                    <img src="colbar.png" id="slider-month-image" style="width: 100%; display: block; margin: 100px auto 20px;"/>
                              </div>
                        </div>
                  </div>
            </section>
      <!-- ======= Footer ======= -->
      <footer id="footer" data-aos="fade-up" data-aos-easing="ease-in-out" data-aos-duration="500">
            <div class="footer-newsletter">
                  <div class="container">
                        <div class="row">
                              <div class="col-lg-6">
                                    <h4>Newsletter</h4>
                                    <p>Subscribe here to get notified when a new material is posted</p>
                              </div>
                              <div class="col-lg-6">
                                    <form action="" method="post">
                                          <input type="email" name="email"><input type="submit" value="Subscribe">
                                    </form>
                              </div>
                        </div>
                  </div>
            </div>
            <div class="footer-top">
                  <div class="container">
                        <div class="row">
                              <div class="col-lg-4 col-md-6 footer-links">
                                    <h4>Useful Links</h4>
                                    <ul>
                                          <li><i class="bx bx-chevron-right"></i> <a href="../../index.html">Home</a></li>
                                          <li><i class="bx bx-chevron-right"></i> <a href="../../about.html">About Me</a></li>
                                          <li><i class="bx bx-chevron-right"></i> <a href="../../projects.html">Projects</a></li>
                                          <li><i class="bx bx-chevron-right"></i> <a href="../../tutorials.html">Tutorials</a></li>
                                    </ul>
                              </div>
                              <div class="col-lg-4 col-md-6 footer-contact">
                                    <h4>Contact</h4>
                                    <p>
                                          6455 2nd St<br>
                                          Alexandria, VA 22312<br>
                                          United States <br><br>
                                          <strong>Phone:</strong> +1 617 460 0555<br>
                                          <strong>Email:</strong> alimehdirahim@gmail.com<br>
                                    </p>
                              </div>
                              <div class="col-lg-4 col-md-6 footer-info">
                                    <h3>About Me</h3>
                                    <p>
                                          A data science enthusiast! I love developing new machine learning algorithms to address real-world problems. I try to learn something new on a daily basis.
                                    </p>
                                    <div class="social-links mt-3">
                                          <a href="https://github.com/alineu" class="Github"><i class="bx bxl-github"></i></a>
                                          <a href="https://www.linkedin.com/in/alimehdizadehrahimi/" class="linkedin"><i class="bx bxl-linkedin"></i></a>
                                          <a href="https://twitter.com/estoyali" class="twitter"><i class="bx bxl-twitter"></i></a>
                                          <a href="https://instagram.com/aliexplores" class="instagram"><i class="bx bxl-instagram"></i></a>
                                    </div>
                              </div>
                        </div>
                  </div>
            </div>
            <div class="container">
                  <div class="copyright">
                        &copy; Copyright 2023 <strong><span>Ali Mehdizadeh Rahimi</span></strong>. All Rights Reserved
                  </div>
                  <div class="credits">
                        <p>
                              Page design is adopted from <a href="https://bootstrapmade.com/">BootstrapMade</a>.<br>Page icons were taken from <a href="https://www.flaticon.com">flaticon.com</a>.
                        </p>
                  </div>
            </div>
            </footer><!-- End Footer -->
            <a href="#" class="back-to-top"><i class="icofont-simple-up"></i></a>
            <!-- Vendor JS Files -->
            <script type="text/javascript" src="../../assets/vendor/jquery/jquery.min.js"></script>
            <script type="text/javascript" src="../../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
            <script type="text/javascript" src="../../assets/vendor/jquery.easing/jquery.easing.min.js"></script>
            <script type="text/javascript" src="../../assets/vendor/php-email-form/validate.js"></script>
            <script type="text/javascript" src="../../assets/vendor/venobox/venobox.min.js"></script>
            <script type="text/javascript" src="../../assets/vendor/waypoints/jquery.waypoints.min.js"></script>
            <script type="text/javascript" src="../../assets/vendor/counterup/counterup.min.js"></script>
            <script type="text/javascript" src="../../assets/vendor/owl.carousel/owl.carousel.min.js"></script>
            <script type="text/javascript" src="../../assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
            <script type="text/javascript" src="../../assets/vendor/prism/prism.js"></script>
            <script type="text/javascript" src="../../assets/vendor/aos/aos.js"></script>
            <!-- Template Main JS File -->
            <script src="../../assets/js/main.js"></script>
            <!-- MathJax JS File -->
            <script>
            MathJax = {
            tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
            }
            };
            </script>
            <script id="MathJax-script"  type="text/javascript" async src="../../assets/mathjax/tex-chtml.js"></script>
      </body>
</html>